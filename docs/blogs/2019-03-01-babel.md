---
title: Babel çš„æ¦‚å¿µæ•´ç†
---

## ä»€ä¹ˆæ˜¯ Babel

Babel æ˜¯ä¸€ä¸ªå·¥å…·é“¾ï¼Œä¸»è¦ç”¨äºå°† ECMA2015+ ä»£ç è½¬æ¢ä¸ºå‘åå…¼å®¹ç‰ˆæœ¬çš„ JS ä»£ç ã€‚

- è½¬æ¢è¯­æ³•
- Polyfill å®ç°ç›®æ ‡ç¯å¢ƒä¸­çš„ç¼ºå°‘åŠŸèƒ½ï¼ˆé€šè¿‡ `@babel/polyfill`)
- æºä»£ç è½¬æ¢ï¼ˆcodemodsï¼‰

### @babel/core

Babel çš„æ ¸å¿ƒåŠŸèƒ½æä¾›ã€‚

ä¾‹ï¼šä»£ç è½¬æ¢ AST

```js
var babel = require('@babel/core')
babel.transform(code, options, function (err, result) {
  result // => { code, map, ast }
})
```

### @babel/cli

Babel å†…ç½®çš„ CLIï¼Œé€šè¿‡å‘½ä»¤è¡Œæ¥ç¼–è¯‘æ–‡ä»¶ã€‚å…è®¸ä½ é€šè¿‡ç»ˆç«¯ä½¿ç”¨ babel çš„å·¥å…·

ä¾‹ï¼šç¼–è¯‘ `./src` è‡³ `./build`

```bash
babel src --out-dir build
```

### Plugins å’Œ Presets

ä½¿ç”¨ `@babel/plugin-transform-arrow-functions` å°†ç®­å¤´å‡½æ•°è½¬æ¢ä¸ºå…¼å®¹çš„å‡½æ•°è¡¨è¾¾å¼

ä½†æ˜¯å¦‚æœè¦åˆ—ä¸¾æƒ³ä½¿ç”¨çš„æ‰€æœ‰æ–°åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ â€œpresetâ€(`@babel/preset-env`) æ¥æ›¿ä»£ä¸€ç»„æ’ä»¶ã€‚

## Polyfill

`@babel/polyfill` æ¨¡å—åŒ…æ‹¬ `core-js` å’Œè‡ªå®šä¹‰ `regenerator runtime` æ¥æ¨¡æ‹Ÿå®Œæ•´çš„ ES2015+ ç¯å¢ƒã€‚

- core-js æä¾› ES5 ES6 ES7 ç­‰è§„èŒƒä¸­æ–°å®šä¹‰çš„å¯¹è±¡å’Œæ–¹æ³•çš„æ¨¡æ‹Ÿå®ç°ã€‚
- regenerator æä¾› regenerator å‡½æ•°æ”¯æŒ

### core-js

```js
require('core-js/fn/set')
new Set()

const Map = require('core-js/library/fn/map')
```

å½“ä½¿ç”¨ `env` present æ—¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª `"useBuiltIns"` é€‰é¡¹ï¼Œç”¨äºé…ç½®å¼•å…¥çš„ `polyfill`

```js
presets: [
  [
    'env',
    {
      useBuiltIns: 'entry',
    },
  ],
]
```

`"useBuiltIns"` å‚æ•°çš„åŒºåˆ«åœ¨äºï¼Œ'entry' åœ¨å…¥å£ä¸­åŠ å…¥ polyfill, ç­‰äº `import 'polyfill'`, è€Œ 'usage' ä¼šæ ¹æ®ä½ æ‰€ä½¿ç”¨çš„æ–° API å¼•å…¥å¯¹åº”çš„ polyfillã€‚

## Babel æ€»ç»“

æˆ‘ä»¬ä½¿ç”¨ `@babel/cli` ä»ç»ˆç«¯è¿è¡Œ Babelï¼Œ`@babel/polyfill` æ¥å®ç°æ‰€æœ‰æ–°çš„ JavaScript åŠŸèƒ½ï¼Œ`env` preset åªåŒ…å«æˆ‘ä»¬ä½¿ç”¨çš„åŠŸèƒ½çš„è½¬æ¢ï¼Œå®ç°æˆ‘ä»¬çš„ç›®æ ‡æµè§ˆå™¨ä¸­ç¼ºå°‘çš„åŠŸèƒ½ã€‚

## shim å’Œ polyfill çš„åŒºåˆ«

- shim æ˜¯æŒ‡ä»…é å·²æœ‰ç¯å¢ƒä¸­å­˜åœ¨çš„ API æ¨¡æ‹Ÿå‡ºä¸€ä¸ªæ–°çš„ APIï¼Œä»¥ä¾¿æ‰€æœ‰ç¯å¢ƒéƒ½å…·æœ‰ç›¸åŒçš„è¡Œä¸ºã€‚
- polyfill æ˜¯ä¸€ä¸ªæµè§ˆå™¨ API çš„ shimã€‚polyfill å…è®¸ web å¼€å‘äººå‘˜ä½¿ç”¨ APIï¼Œè€Œä¸ç®¡æµè§ˆå™¨æ˜¯å¦æ”¯æŒå®ƒã€‚

[shim](<https://zh.wikipedia.org/wiki/%E5%9E%AB%E7%89%87_(%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1)>) å’Œ polyfill æ˜¯ç¨‹åºè®¾è®¡ä¸­çš„æ¦‚å¿µï¼Œå¹¶ä¸æ˜¯ JS ä¸­ç‹¬æœ‰çš„æ¦‚å¿µã€‚

åœ¨ JS ä¸­ shim ä¸ polyfill çš„åŒºåˆ«åœ¨äºåˆ›å»ºçš„ API æ˜¯å¦åœ¨é«˜çº§çš„æµè§ˆå™¨ä¸­å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨é‚£ä¹ˆå°±æ˜¯ shimï¼Œå¦åˆ™æ˜¯ polyfillã€‚

![å›¾](./artem-yavorsky-99-ways-to-take-away-your-ugly-polyfills-5-1024.jpg)

è¿˜æœ‰ä¸€ç§è¯´æ³•æ˜¯ï¼Œshim æŒ‡ ECMAScript è¯­æ³•ï¼Œè€Œ polyfill æŒ‡ æµè§ˆå™¨ç¯å¢ƒ APIã€‚

ä¸ªäººæ„Ÿè§‰ä»¥ä¸Šè¯´æ³•éƒ½å¯ä»¥ä½œä¸ºç†è§£çš„å‚è€ƒï¼Œå¹¶ä¸ä¸€å®šè¦æœ‰ 100%å‡†ç¡®çš„ç­”æ¡ˆ

## çœ‹ä¸€ä¸ªä½¿ç”¨çš„ä¾‹å­

```js
class MyApp {
    async load() {
        const data = await fetch('data')
    }
}

npm i -D @babel/core @babel/preset-env
```

ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ˜¯ ğŸ‘

```js
const set = new Set()
const obj = Object.freeze(x)
const user = Reflect.construct(User, args)
Array.from(nodes)

// Uncaught ReferenceError: Map is not defined

// Uncaught TypeError: Object.freeze is not a function

// Uncaught ReferenceError: Reflect is not defined
```

ä½†è¿™é‡Œçš„ä»£ç ç‰‡æ®µæ˜¯ ğŸ‘

**Transpiling != Polyfilling**

> Transpilers are also known as source-to-source compilers. So in essence they are a subset of compilers which take in a source code file and convert it to another source code file in some other language or a different version of the same language. The ouput is generally understandable by a human. This output still has to go through a compiler or interpreter to be able to run on the machine.

Transpiling = new syntax

Polyfilling = new API

åŠ å…¥ polyfill

```
npm i -D @babel/polyfill
```

```js
fetch('/user')
imageCapture = new ImageCapture(track)
const myRequest = new Request('user.jpg')
const searchParams = new URLSearchParams(paramsString)

// Uncaught ReferenceError: fetch is not defined
```

**Javascript API != Browser API**

Browser API: https://caniuse.com

Javascript API: https://kangax.github.io/compat-table/es6/

```
npm i whatwg-fetch
npm i image-capture
npm i classlist.js
```

ğŸ‘

ç¼–è¾‘å™¨ä¸­è·å–å…¼å®¹æ€§æ£€æŸ¥ï¼š

[eslint-plugin-compat](https://www.npmjs.com/package/eslint-plugin-compat)

### polyfill.io

polyfill.io å…è®¸ä½ ä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼Œåˆ¤æ–­å½“å‰æµè§ˆå™¨ç¯å¢ƒæ˜¯å¦éœ€è¦åŠ å…¥ polyfillã€‚

```js
var features = []
'Promise' in window || features.push('Promise')
```

ä½ éœ€è¦è¿½è¸ªæ‰€ä½¿ç”¨çš„æ‰€æœ‰ç‰¹æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹è„šæœ¬ä¼šå¼‚æ­¥çš„æ·»åŠ åˆ°æ–‡æ¡£ä¸­ï¼Œç„¶åæµè§ˆå™¨ä¼šæ‰§è¡Œè„šæœ¬ï¼Œå¹¶å‘ polyfill.io è¯·æ±‚æ‰€éœ€è¦çš„ç‰¹æ€§

### bundle-utils

æä¾›ä¸€ä¸ªé’ˆå¯¹ä¸åŒæµè§ˆå™¨å…¼å®¹çš„æ‰“åŒ…ç­–ç•¥

### å‚è€ƒ

- [99 ways to take away your ugly polyfills](https://www.slideshare.net/fwdays/artem-yavorsky-99-ways-to-take-away-your-ugly-polyfills)
- [What is the difference between a shim and a polyfill?](https://stackoverflow.com/questions/6599815/what-is-the-difference-between-a-shim-and-a-polyfill)
- [ä½¿ç”¨æŒ‡å— Babel](https://babel.docschina.org)
